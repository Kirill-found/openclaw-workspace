# 2026-02-18 — Wall of Love: от идеи до рабочего прототипа

## Ключевые решения
- **Концепция уточнена**: НЕ сервис сбора отзывов через формы. Это сервис который ПАРСИТ отзывы с Яндекс Карт и 2ГИС и показывает виджетом на сайте клиента
- Кирилл чётко сказал: "зачем ты переделал на свою какую то форму, кому она нахуй нужна?" — формы не нужны, только парсинг
- Фильтрация: по дефолту виджет показывает только 4-5 звёзд (min_rating в настройках виджета)

## Что сделано
### Скрейпинг
- **Яндекс Карты ✅**: Playwright non-headless → DOM-парсинг → работает
  - Селекторы: `.business-reviews-card-view__review`, `.business-review-view__body`, `.business-review-view__author-name`
  - Аватарки: `.user-icon-view__icon` → backgroundImage → URL с avatars.mds.yandex.net
  - URL: `https://yandex.ru/maps/org/{orgId}/reviews/` (НЕ hardcode "yandeks" в пути!)
  - Рейтинг: aria-label "Оценка X Из 5"
  - 37 реальных отзывов с ДаблБи Добрынинская (org ID: 1741097232)
  - 30 из 37 с реальными фото аватарок
- **2ГИС ❌**: 403 Forbidden — банит датацентр IP, нужен residential proxy

### Rails-приложение
- Путь: `/Users/karavan/Developer/walloflove/`
- Ruby 3.3.7 (rbenv), Rails 7.2, PostgreSQL 16 (brew), Tailwind CSS
- **Модели**: User (Devise), Organization, Review, Widget
- **Скрейпер**: `app/services/yandex_scraper.rb` + `lib/scrapers/yandex.js`
- **API**: `/api/widget/:slug.json` — отдаёт отзывы с фильтрацией по min_rating
- **Демо**: demo@walloflove.ru / password123
- Сервер: порт 4000 (3000 занят Remotion)

### Embed-виджет
- `/public/widget.js` — Shadow DOM, карусель, drag/swipe, автопрокрутка
- Premium дизайн: Plus Jakarta Sans + DM Sans, SVG-звёзды с полузвёздами, frosted glass рейтинг-бар
- Аватарки реальных пользователей с Яндекса
- Бейджи источников (Яндекс красный, 2ГИС зелёный)
- "Читать дальше" для длинных текстов
- Демо-страница: `/public/demo-site.html`
- Вставка: `<div data-wol-widget="slug" data-wol-host="..."></div><script src=".../widget.js"></script>`

## Референс дизайна
- delovoy-centr.prezi-dent.ru — блок отзывов с карусели, шапка с агрегированным рейтингом + табы по источникам

## Среда
- PostgreSQL: `brew services start postgresql@16`, PATH нужен `/opt/homebrew/opt/postgresql@16/bin`
- Ruby: `eval "$(rbenv init -)"` перед каждой командой
- Playwright: `npm install` в директории walloflove

## Ошибки сессии
- Сначала сделал формы сбора вместо парсинга — Кирилл был недоволен, переделывал
- Hardcoded "yandeks" в URL скрейпера → таймаут
- Math.round(4.5)=5 в звёздах → показывало 5 вместо 4.5
- Субагенты на модели sonnet-4-6 не работают — только `model: "opus"`

## Сессия 2 — Виджеты, лендинг, авторизация, деплой

### 5 форматов виджетов
- **Carousel** (основной), **Masonry Grid**, **Floating Badge**, **List View**, **Footer Informer**
- Masonry hover баг пофикшен: `transform: none` чтоб не скакали колонки
- Floating badge переделан: не чат-кнопка, а виджет рейтинга `[Я] 4.5 ★★★★★ 37 отзывов`
- Демо-страницы: `demo-card.html`, `demo-card2.html`, `demo-formats.html`

### Лендинг
- `public/landing.html` (35KB) — всё inline (CSS+JS)
- Dark hero, 5 живых демо виджетов, 3 шага "как работает", тарифы, FAQ аккордеон
- Шрифт Plus Jakarta Sans, scroll-reveal анимации
- Реальные аватарки с `avatars.mds.yandex.net` (не pravatar.cc)
- **Тарифы**: Free (15 отзывов, 1 виджет) → Стартер 690₽ → Бизнес 1490₽ → Агентство 2990₽

### Авторизация (Devise)
- Регистрация, логин, логаут, восстановление пароля
- Стилизация Tailwind, русская локаль (`config/locales/devise.ru.yml`)
- `User has_many :organizations`, dashboard защищён `authenticate_user!`
- Без email confirmation для MVP

### Деплой на Timeweb VDS
- IP: 89.169.2.143, Ubuntu 22.04
- root / `vgz^4hkW#jWM-5`
- Субагент запущен: Ruby 3.3.7 (rbenv), PostgreSQL, Nginx reverse proxy, Puma systemd
- Gemfile фикс: `platforms: %i[ mingw mswin x64_mingw jruby ]` (было `windows` — ломало bundler)

### Дизайн-система виджетов (финальная)
- Звёзды: #FFB900 (золотые)
- Яндекс иконка: красный круг #FC3F1D с белой "Я" (НЕ пин, НЕ иконка приложения)
- 2ГИС: зелёный #32A445 с "2G"
- Stats bar: pill (border-radius: 100px), compact inline-flex
- Source icon: floating top-right (position: absolute)
- Дата: просто "DD месяц YYYY" без источника

## Следующие шаги
- Проверить деплой на 89.169.2.143
- DNS walloflove.ru → 89.169.2.143 + SSL (certbot)
- Миграция `author_avatar_url` в БД, обновить API JSON, ре-скрейп
- 2ГИС: residential proxy
- Xvfb + Playwright на сервере для headless скрейпинга
- Sidekiq для фоновых задач
- UI "Добавить организацию" (вставить URL → автодетект → скрейп → embed код)
- Биллинг
