# 2026-02-09

## Le Nez iOS App - Major UI/UX Redesign

### Fragrantica Integration Complete
- **ImageProvider.swift**: Now uses Fragrantica CDN `https://fimgs.net/mdimg/perfume/375x500.{ID}.jpg`
- **IngredientImageProvider.swift**: Uses `https://fimgs.net/mdimg/sastojci/o.{ID}.jpg` (original size)
- **PerfumeDatabase.swift**: `bottleImageURL` is now computed from `fragranticaID`
- Copied 70K perfumes + 1900 ingredients JSON to `/Users/karavan/Developer/Le Nez/Le Nez/Resources/`

### Theme System Created
New `Theme.swift` with warm, luxurious color palette:
- **Colors**: deepAmber, richBrown, warmGold, softGold, cream, warmWhite
- **Note colors**: topNoteColor (citrus gold), heartNoteColor (rose), baseNoteColor (deep amber)
- **Gradients**: backgroundGradient, goldGradient, glowGradient
- **View extensions**: `.leNezBackground()`, `.goldGlow()`, `.leNezCard()`

### OnboardingView Redesigned
- Warm gradient background
- Animated logo with glow effect
- Serif typography (Baskerville)
- Vibe examples grid
- Gold CTA button with shadow

### Still To Do
- Apply Theme to ScannerView
- Apply Theme to ResultView
- Create triangular pyramid layout in FragrancePyramidView
- Add glow effects around ingredient images
- Redesign PerfumeCard components

### Project Paths
- **App**: `/Users/karavan/Developer/Le Nez/Le Nez/`
- **Fragrantica data**: `/Users/karavan/.openclaw/workspace/fragrantica/`

### "Neo-Clinical Luxury" Light Theme (NEW DIRECTION)
User rejected warm/amber theme. New direction: clean, professional, light theme like Fragrantica.

**Theme Colors**:
- White (#FFFFFF), Ghost White (#F8F9FA) - backgrounds
- Obsidian (#1A1A1A) - text
- Gold (#D4AF37) - accents

**Completed**:
- Theme.swift updated for light theme
- OnboardingView.swift redesigned
- ScannerView.swift updated
- FragrancePyramidView.swift updated + `SimpleImageCache` actor embedded
- ResultView.swift: New Metric Grid, Segmented Control, 4-column ingredient LazyVGrid
- PerfumeStoreLinks.swift: Direct links to FragranceX (primary), Sephora, Nordstrom

**Additional Fixes**:
- **ImageCache.swift**: Shared actor service (NSCache 50MB + disk 100MB) - replaced per-view SimpleImageCache
- **ImageProvider.swift**: Returns `nil` instead of fallback URL for unknown perfumes (placeholder shown)
- **nichePerfumeIDs**: Dictionary added with Fragrantica IDs for niche brands (Imaginary Authors, Byredo, Le Labo, MFK, Diptyque, Frederic Malle, Amouage, Xerjoff, Initio, PDM, Nishane, DS & Durga, Zoologist, etc.)
- **IngredientImageProvider.swift**: Expanded `aliases` dictionary (woods, florals, fruits, spices, gourmand, musks, resins, green/fresh, leather/smoke)

**TabBar Navigation Implemented**:
- **MainTabView.swift**: 4 tabs - Scan/History/Favorites/Settings
- **SwiftData Models**: ScanHistory, FavoritePerfume with persistence
- **AI Prompt Updated**: Requests 2-3 niche brands, 1-2 designer, 1 hidden gem

**Build Issue Fixed**: "Cannot find 'ImageCache' in scope" - solved by embedding `SimpleImageCache` actor directly in view files rather than fixing Xcode project references.

### Critical Bug Fixes (Late Session)
1. **Removed fake fragranticaID from GPT prompt**: GPT was inventing IDs → wrong bottle images
2. **Deleted knownPerfumeIDs entirely**: ~90% of 350+ hardcoded IDs were wrong
3. **Brand normalization fixed**: Dashes → spaces in both DB keys and search keys
4. **Brand aliases added**: Jo Malone→Jo Malone London, Kilian→By Kilian, MFK→Maison Francis Kurkdjian, etc.
5. **O(n) partial matching REMOVED**: Was freezing UI on 70K records; now O(1) lookups only
6. **Background preload with NSLock**: Thread-safe database loading at app launch
7. **Added 39 perfumes to bottles_labels.json** + 30+ ingredient mappings
8. **AI timeout increased to 120s**, pyramid prompt updated for fuller responses

### Known Issue - OpenAI Null Content
- **Error**: JSON decode failure at OpenAIService.swift line 87
- **Cause**: OpenAI API returns `null` for `content` field (possibly content filter)
- **Fix needed**: Change `content: String` to `content: String?` in Message struct (check VibeResult.swift and OpenAIService.swift)
- **Network instability**: QUIC keep-alive failures, -1001 timeouts (WiFi issue?)

---

## Timly HR - Package System Implementation

### Server Details
- **IP**: 188.225.24.157
- **SSH**: root / `gx1uGPsVs?HA5M`
- **DB**: PostgreSQL, user `timly`, database `timly_dev`, container `timly_db_1`
- **Project Path**: `/root/timly`
- **Local**: `/Users/karavan/Developer/timly`
- **GitHub**: `mikhail-khabirov/timly`, token `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`

### Completed Today
1. **DB Corruption Fixed**: MultiXactId error resolved by recreating pg_multixact dirs
2. **6 Plans Created**: Trial(50), Start(1000), Grow(3000), Pro(7000), Business(15000), Enterprise(30000)
3. **Trial Subscriptions**: All 28 users now have Trial with 50 analyses
4. **Frontend Fix**: API URL was localhost:8000, now https://timly-hr.ru
5. **canPurchase() Fix**: Check `plan?.plan_type === 'trial'` not `status === 'trial'`
6. **Admin Panel Fix**: `days_remaining` now handles `None` for unlimited packages
7. **Admin.tsx Updated**: New package types, badge colors for package-based system
8. **Delete User API**: Added `DELETE /api/admin/users/{user_id}` with cascade delete

### In Progress
- **Delete User Button**: Need to add `deleteUser` function + button in users table + confirmation dialog in Admin.tsx (API done)

### Visual Updates - COMPLETED
- ✅ Menu swap: Синхронизация above Анализ резюме с HH
- ✅ Menu labels: "Анализ резюме с HH", "Анализ резюме PDF/DOC"
- ✅ "Тарифы" → "Пакеты" in menu and page titles
- ✅ Logo "Timly HR" everywhere
- ✅ Copyright "© 2025-2026 Timly HR"
- ✅ Sidebar widened to 260px
- ✅ Removed vacancy limit from Settings

### Visual Updates TODO (remaining from ТЗ PDF)
- Landing: Show 3 packages (Start, Grow, Pro), mark Pro as popular
- FAQ: Fix auto-renewal question (no auto-renewal now)
- Privacy.tsx, Terms.tsx, Offer.tsx: New legal texts
- Remove "Есть вопросы? Пишите" on packages page
- Manual analysis: Add * to required fields
- Checkout: "Подписка" → "Пакет"
- Update meta tags

### Key Architecture
- Packages are **бессрочные** (no expiration, `expires_at = None`)
- Purchases ADD analyses to existing balance
- Trial check: `plan.plan_type === 'trial'`
- Docker: `docker-compose.prod.yml`, frontend via `docker run` with SSL certs mount
